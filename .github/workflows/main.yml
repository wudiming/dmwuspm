name: æ„å»ºå¹¶å‘å¸ƒ SPlayer

# æ‰‹åŠ¨è§¦å‘ï¼Œå¹¶åœ¨è§¦å‘æ—¶è¾“å…¥ Release åç§°
on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'è¯·è¾“å…¥æœ¬æ¬¡ Release çš„åç§°ï¼Œç”¨äºæ‰“åŒ…æ–‡ä»¶åå’Œ GitHub Release æ ‡ç­¾'
        required: true

jobs:
  build-and-release:
    name: ç¼–è¯‘ & å‘å¸ƒæµç¨‹
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # æ­¥éª¤ 1ï¼šå…‹éš† SPlayer ä»“åº“çš„ master-fix åˆ†æ”¯
      # ----------------------------------------------------
      - name: å…‹éš† SPlayer(master-fix åˆ†æ”¯)
        run: |
          echo "å¼€å§‹å…‹éš† IamFurina/SPlayer ä»“åº“çš„ master-fix åˆ†æ”¯..."
          git clone --branch master-fix https://github.com/IamFurina/SPlayer.git splayer
          echo "å…‹éš†å®Œæˆï¼Œç›®å½•ï¼šsplayer"

      # ----------------------------------------------------
      # æ­¥éª¤ 2ï¼šå¤åˆ¶ .env.example åˆ° .env
      # ----------------------------------------------------
      - name: å‡†å¤‡ç¯å¢ƒé…ç½®æ–‡ä»¶ (.env)
        run: |
          echo "å¤åˆ¶ .env.example ä¸º .env æ–‡ä»¶..."
          cp splayer/.env.example splayer/.env
          echo "å¤åˆ¶å®Œæˆï¼šsplayer/.env"

      # ----------------------------------------------------
      # æ­¥éª¤ 3ï¼šå†™å…¥å¹¶æ‰§è¡Œ Python è„šæœ¬æ¥æ›´æ–° .env
      # ----------------------------------------------------
      - name: å†™å…¥ Env æ›´æ–°è„šæœ¬
        run: |
          cat << 'EOF' > splayer/update_env.py
          #!/usr/bin/env python3
          import io, sys

          env_file = 'splayer/.env'
          # è¯»å–åŸå§‹æ–‡ä»¶
          with io.open(env_file, 'r', encoding='utf-8') as f:
              lines = f.readlines()

          # å®šä¹‰è¦æ›¿æ¢çš„é”®å€¼
          mapping = {
              'RENDERER_VITE_SERVER_URL': 'https://musicapi.881128.xyz',
              'VITE_UNM_API': 'https://unm.881128.xyz/',
              'RENDERER_VITE_SITE_URL': 'https://music.881128.xyz'
          }

          new_lines = []
          for line in lines:
              # å¦‚æœæ˜¯ç›®æ ‡è¡Œï¼Œå°±æ›¿æ¢
              for key, val in mapping.items():
                  if line.startswith(f"{key}="):
                      line = f"{key}={val}\n"
                      break
              new_lines.append(line)

          # å†™å›æ–‡ä»¶
          with io.open(env_file, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)

          # æ‰“å°ç»“æœä»¥ä¾›éªŒè¯
          print("===== .env æ–‡ä»¶ä¿®æ”¹åå†…å®¹ =====")
          with io.open(env_file, 'r', encoding='utf-8') as f:
              sys.stdout.write(f.read())
          print("===== ç»“æŸ =====")
          EOF

      - name: æ‰§è¡Œ Env æ›´æ–°è„šæœ¬
        run: |
          echo "å¼€å§‹é€šè¿‡ Python è„šæœ¬æ‰¹é‡æ›¿æ¢ .env ä¸­çš„é…ç½®é¡¹..."
          python3 splayer/update_env.py

      # ----------------------------------------------------
      # æ­¥éª¤ 4ï¼šè®¾ç½® Node.js ç¯å¢ƒï¼ˆä½¿ç”¨æœ€æ–° LTS ç‰ˆæœ¬ï¼‰
      # ----------------------------------------------------
      - name: è®¾ç½® Node.js (æœ€æ–° LTS)
        uses: actions/setup-node@v3
        with:
          node-version: lts/*
          cache: 'npm'
          cache-dependency-path: splayer/package-lock.json

      # ----------------------------------------------------
      # æ­¥éª¤ 5ï¼šå®‰è£… npm ä¾èµ–ï¼Œæ˜¾ç¤ºè¯¦ç»†å®‰è£…è¿›åº¦
      # ----------------------------------------------------
      - name: å®‰è£… npm ä¾èµ–
        working-directory: splayer
        run: |
          echo "ğŸ”§ å¼€å§‹å®‰è£… npm ä¾èµ–..."
          npm install --verbose
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # ----------------------------------------------------
      # æ­¥éª¤ 6ï¼šæ‰§è¡Œé¡¹ç›®æ„å»ºï¼Œæ˜¾ç¤ºè¯¦ç»†æ„å»ºæ—¥å¿—
      # ----------------------------------------------------
      - name: æ„å»ºé¡¹ç›® (npm run build)
        working-directory: splayer
        run: |
          echo "ğŸ—ï¸  å¼€å§‹é¡¹ç›®æ„å»º..."
          npm run build --verbose
          echo "âœ… æ„å»ºå®Œæˆ"

      # ----------------------------------------------------
      # æ­¥éª¤ 7ï¼šæ‰“åŒ… out/renderer ç›®å½•ï¼ˆç”Ÿæˆ .zip å’Œ .tar.gzï¼‰
      # ----------------------------------------------------
      - name: æ‰“åŒ… renderer è¾“å‡ºç›®å½•
        run: |
          echo "ğŸ“¦ æ‰“åŒ… splayer/out/renderer ç›®å½•..."
          cd splayer/out
          zip -r "../${{ github.event.inputs.release_name }}.zip" renderer
          tar -czf "../${{ github.event.inputs.release_name }}.tar.gz" renderer
          echo "âœ… æ‰“åŒ…å®Œæˆï¼šç”Ÿæˆ .zip å’Œ .tar.gz æ–‡ä»¶"

      # ----------------------------------------------------
      # æ­¥éª¤ 8ï¼šåˆ›å»º GitHub Release å¹¶ä¸Šä¼ ä¸¤ä¸ªå‹ç¼©åŒ…
      # ----------------------------------------------------
      - name: å‘å¸ƒ Release å¹¶ä¸Šä¼ èµ„äº§
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_name }}
          name: ${{ github.event.inputs.release_name }}
          files: |
            splayer/out/${{ github.event.inputs.release_name }}.zip
            splayer/out/${{ github.event.inputs.release_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
