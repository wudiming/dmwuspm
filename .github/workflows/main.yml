name: æ„å»ºå¹¶å‘å¸ƒ SPlayer

# 1. æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼Œå¹¶è®©ç”¨æˆ·åœ¨è§¦å‘æ—¶è¾“å…¥ Release åç§°
on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'è¯·è¾“å…¥æœ¬æ¬¡ Release çš„åç§°ï¼Œç”¨äºæ‰“åŒ…æ–‡ä»¶åå’Œ GitHub Release æ ‡ç­¾'
        required: true

jobs:
  build-and-release:
    name: ç¼–è¯‘ & å‘å¸ƒæµç¨‹
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # æ­¥éª¤ 1ï¼šæ£€å‡ºå½“å‰ä»“åº“ï¼ˆæƒé™é…ç½®ï¼‰
      # ----------------------------------------------------
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v3
        with:
          # å¦‚æœä½ éœ€è¦æ‹‰å– submoduleï¼Œå¯ä»¥åœ¨æ­¤å¼€å¯
          submodules: 'recursive'
      
      # ----------------------------------------------------
      # æ­¥éª¤ 2ï¼šå…‹éš† SPlayer ä»“åº“çš„ master-fix åˆ†æ”¯
      # ----------------------------------------------------
      - name: å…‹éš† SPlayer(master-fix åˆ†æ”¯)
        run: |
          echo "å¼€å§‹å…‹éš† IamFurina/SPlayer ä»“åº“çš„ master-fix åˆ†æ”¯..."
          git clone --branch master-fix https://github.com/IamFurina/SPlayer.git splayer
          echo "å…‹éš†å®Œæˆï¼Œç›®å½•ï¼šsplayer"

      # ----------------------------------------------------
      # æ­¥éª¤ 3ï¼šå¤åˆ¶ .env.example åˆ° .env
      # ----------------------------------------------------
      - name: å‡†å¤‡ç¯å¢ƒé…ç½®æ–‡ä»¶ (.env)
        run: |
          echo "å¤åˆ¶ .env.example ä¸º .env æ–‡ä»¶..."
          cp splayer/.env.example splayer/.env
          echo "å¤åˆ¶å®Œæˆï¼šsplayer/.env"

      # ----------------------------------------------------
      # æ­¥éª¤ 4ï¼šä½¿ç”¨ Python ä¿®æ”¹ .env ä¸­çš„å˜é‡å€¼
      # ----------------------------------------------------
      - name: ä½¿ç”¨ Python æ›´æ–° .env é…ç½®
        run: |
          echo "å¼€å§‹é€šè¿‡ Python è„šæœ¬æ‰¹é‡æ›¿æ¢ .env ä¸­çš„é…ç½®é¡¹..."
          python3 - << 'EOF'
import io, sys

env_file = 'splayer/.env'
# è¯»å–åŸå§‹æ–‡ä»¶å†…å®¹
with io.open(env_file, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# æ–°çš„é…ç½®å€¼æ˜ å°„è¡¨
mapping = {
    'RENDERER_VITE_SERVER_URL': 'https://musicapi.881128.xyz',
    'VITE_UNM_API': 'https://unm.881128.xyz/',
    'RENDERER_VITE_SITE_URL': 'https://music.881128.xyz'
}

new_lines = []
for line in lines:
    # å¦‚æœè¡Œä»¥æŸä¸ªå˜é‡åå¼€å¤´ï¼Œåˆ™æ›¿æ¢è¯¥è¡Œ
    for key, val in mapping.items():
        if line.startswith(f"{key}="):
            line = f"{key}={val}\n"
            break
    new_lines.append(line)

# å°†æ›¿æ¢åçš„å†…å®¹å†™å›æ–‡ä»¶
with io.open(env_file, 'w', encoding='utf-8') as f:
    f.writelines(new_lines)

# è¾“å‡ºä¿®æ”¹åçš„å®Œæ•´æ–‡ä»¶å†…å®¹ï¼Œä»¥ä¾¿è°ƒè¯•æŸ¥çœ‹
print("===== .env æ–‡ä»¶ä¿®æ”¹åå†…å®¹ =====")
with io.open(env_file, 'r', encoding='utf-8') as f:
    sys.stdout.write(f.read())
print("===== ç»“æŸ =====")
EOF

      # ----------------------------------------------------
      # æ­¥éª¤ 5ï¼šè®¾ç½® Node.js ç¯å¢ƒï¼ˆä½¿ç”¨æœ€æ–° LTS ç‰ˆæœ¬ï¼‰
      # ----------------------------------------------------
      - name: è®¾ç½® Node.js (æœ€æ–° LTS)
        uses: actions/setup-node@v3
        with:
          # æŒ‡å®šä½¿ç”¨æœ€æ–°çš„ LTS ç‰ˆæœ¬
          node-version: lts/*
          # è‡ªåŠ¨ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache: 'npm'
          cache-dependency-path: splayer/package-lock.json

      # ----------------------------------------------------
      # æ­¥éª¤ 6ï¼šå®‰è£…é¡¹ç›®ä¾èµ–ï¼Œæ˜¾ç¤ºè¯¦ç»†å®‰è£…è¿›åº¦
      # ----------------------------------------------------
      - name: å®‰è£… npm ä¾èµ–
        working-directory: splayer
        run: |
          echo "ğŸ”§ å¼€å§‹å®‰è£… npm ä¾èµ–..."
          npm install --verbose
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # ----------------------------------------------------
      # æ­¥éª¤ 7ï¼šæ‰§è¡Œé¡¹ç›®æ„å»ºï¼Œæ˜¾ç¤ºè¯¦ç»†æ„å»ºæ—¥å¿—
      # ----------------------------------------------------
      - name: æ„å»ºé¡¹ç›® (npm run build)
        working-directory: splayer
        run: |
          echo "ğŸ—ï¸  å¼€å§‹é¡¹ç›®æ„å»º..."
          npm run build --verbose
          echo "âœ… æ„å»ºå®Œæˆ"

      # ----------------------------------------------------
      # æ­¥éª¤ 8ï¼šæ‰“åŒ… out/renderer æ–‡ä»¶å¤¹
      # ----------------------------------------------------
      - name: æ‰“åŒ… renderer è¾“å‡ºç›®å½•
        run: |
          echo "ğŸ“¦ æ‰“åŒ… splayer/out/renderer ç›®å½•..."
          cd splayer/out
          zip -r "../${{ github.event.inputs.release_name }}.zip" renderer
          echo "âœ… æ‰“åŒ…å®Œæˆï¼šsplayer/out/${{ github.event.inputs.release_name }}.zip"

      # ----------------------------------------------------
      # æ­¥éª¤ 9ï¼šåˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶
      # ----------------------------------------------------
      - name: å‘å¸ƒ Release å¹¶ä¸Šä¼ èµ„äº§
        uses: softprops/action-gh-release@v1
        with:
          # æ ‡ç­¾åä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ release_name
          tag_name: ${{ github.event.inputs.release_name }}
          # Release åç§°åŒæ ‡ç­¾å
          name: ${{ github.event.inputs.release_name }}
          # ä¸Šä¼ åˆšæ‰ç”Ÿæˆçš„ zip åŒ…
          files: splayer/out/${{ github.event.inputs.release_name }}.zip
        env:
          # ä½¿ç”¨å†…ç½®çš„ GITHUB_TOKEN è‡ªåŠ¨è®¤è¯
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
