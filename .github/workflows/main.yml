name: æ„å»ºå¹¶å‘å¸ƒ SPlayer

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'è¯·è¾“å…¥æœ¬æ¬¡ Release çš„åç§°ï¼Œç”¨äºæ‰“åŒ…æ–‡ä»¶åå’Œ GitHub Release æ ‡ç­¾'
        required: true

jobs:
  build-and-release:
    name: ç¼–è¯‘ & å‘å¸ƒæµç¨‹
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1ï¼šå…‹éš†æŒ‡å®šåˆ†æ”¯
      - name: å…‹éš† SPlayer(master-fix åˆ†æ”¯)
        run: |
          echo "å¼€å§‹å…‹éš† IamFurina/SPlayer ä»“åº“çš„ master-fix åˆ†æ”¯..."
          git clone --branch master-fix https://github.com/IamFurina/SPlayer.git splayer
          echo "å…‹éš†å®Œæˆ"

      # æ­¥éª¤ 2ï¼šå¤åˆ¶ .env.example ä¸º .env
      - name: å‡†å¤‡ .env æ–‡ä»¶
        run: |
          echo "å¤åˆ¶ .env.example ä¸º .env..."
          cp splayer/.env.example splayer/.env
          echo "å¤åˆ¶å®Œæˆ"

      # æ­¥éª¤ 3ï¼šPython ä¸€æ­¥æ›¿æ¢ .env å†…å®¹å¹¶è¾“å‡ºç»“æœ
      - name: æ›´æ–° .env å˜é‡
        run: |
          echo "å¼€å§‹æ›´æ–° .env..."
          python3 - << 'EOF'
#!/usr/bin/env python3
import re, sys

env_path = 'splayer/.env'
with open(env_path, 'r', encoding='utf-8') as f:
    content = f.read()

mapping = {
    'RENDERER_VITE_SERVER_URL': 'https://musicapi.881128.xyz',
    'VITE_UNM_API':              'https://unm.881128.xyz/',
    'RENDERER_VITE_SITE_URL':    'https://music.881128.xyz'
}

for key, val in mapping.items():
    # åŒ¹é… key= å‰é¢å¯èƒ½æœ‰ç©ºæ ¼ï¼Œvalue ç»Ÿä¸€åŠ åŒå¼•å·
    content = re.sub(
        rf'^{key}\s*=.*$',
        f'{key} = "{val}"',
        content,
        flags=re.MULTILINE
    )

with open(env_path, 'w', encoding='utf-8') as f:
    f.write(content)

print("===== .env ä¿®æ”¹åå†…å®¹ =====")
print(content)
print("===== ç»“æŸ =====")
EOF

      # æ­¥éª¤ 4ï¼šè®¾ç½® Node.jsï¼ˆæœ€æ–° LTSï¼‰ã€ç¼“å­˜ npm
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: splayer/package.json

      # æ­¥éª¤ 5ï¼šå®‰è£…ä¾èµ–ï¼ˆverbose æ¨¡å¼ï¼‰
      - name: å®‰è£… npm ä¾èµ–
        working-directory: splayer
        run: |
          echo "ğŸ”§ å®‰è£…ä¾èµ–ä¸­..."
          npm install --verbose
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # æ­¥éª¤ 6ï¼šæ„å»ºé¡¹ç›®ï¼ˆverbose æ¨¡å¼ï¼‰
      - name: æ„å»ºé¡¹ç›®
        working-directory: splayer
        run: |
          echo "ğŸ—ï¸ æ„å»ºä¸­..."
          npm run build --verbose
          echo "âœ… æ„å»ºå®Œæˆ"

      # æ­¥éª¤ 7ï¼šæ‰“åŒ… renderer è¾“å‡ºï¼ˆ.zip & .tar.gzï¼‰
      - name: æ‰“åŒ… renderer ç›®å½•
        run: |
          echo "ğŸ“¦ æ‰“åŒ… splayer/out/renderer..."
          cd splayer/out
          zip -r "../${{ github.event.inputs.release_name }}.zip" renderer
          tar -czf "../${{ github.event.inputs.release_name }}.tar.gz" renderer
          echo "âœ… æ‰“åŒ…å®Œæˆ"

      # æ­¥éª¤ 8ï¼šåˆ›å»º Release å¹¶ä¸Šä¼ ä¸¤ç§å‹ç¼©åŒ…
      - name: å‘å¸ƒ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_name }}
          name:     ${{ github.event.inputs.release_name }}
          files: |
            splayer/out/${{ github.event.inputs.release_name }}.zip
            splayer/out/${{ github.event.inputs.release_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
